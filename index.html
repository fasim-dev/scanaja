<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="theme-color" content="#4CAF50"/>
  <title>ScanAja</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="icon-192x192.png" type="image/png" />
  <style>
    :root {
      --primary: #4CAF50;
      --primary-dark: #388E3C;
      --secondary: #2196F3;
      --danger: #F44336;
      --bg-light: #f9f9f9;
      --bg-dark: #121212;
      --card-light: #fff;
      --card-dark: #1f1f1f;
      --text-light: #fff;
      --text-dark: #222;
      --text-muted: #666;
      --text-muted-dark: #aaa;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: var(--bg-light);
      color: var(--text-dark);
      transition: all 0.3s ease;
      line-height: 1.6;
    }

    .dark-mode {
      background: var(--bg-dark);
      color: var(--text-light);
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.8rem 1rem;
      background: var(--primary);
      color: white;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo img {
      width: 32px;
      height: 32px;
    }

    .menu-toggle {
      font-size: 1.6rem;
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: background 0.2s;
    }

    .menu-toggle:hover {
      background: rgba(255,255,255,0.1);
    }

    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      height: 100%;
      width: 280px;
      background: #2c3e50;
      color: white;
      padding: 1.5rem 1rem;
      transition: transform 0.3s ease;
      z-index: 1000;
      transform: translateX(-100%);
      overflow-y: auto;
    }

    .sidebar.open {
      transform: translateX(0);
    }

    .sidebar h2 {
      font-size: 1.3rem;
      margin-bottom: 1.5rem;
      color: var(--primary);
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .sidebar a {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 14px;
      margin: 8px 0;
      background: rgba(255,255,255,0.1);
      color: #fff;
      border-radius: 8px;
      text-decoration: none;
      transition: all 0.2s;
      font-size: 0.95rem;
    }

    .sidebar a:hover {
      background: var(--primary);
      transform: translateX(4px);
    }

    .sidebar a i {
      font-size: 1.1rem;
      width: 24px;
      text-align: center;
    }

    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      z-index: 999;
      backdrop-filter: blur(3px);
    }

    .overlay.show {
      display: block;
    }

    main {
      max-width: 600px;
      margin: 0 auto;
      padding: 1rem;
      transition: margin 0.3s;
    }

    .box {
      background: var(--card-light);
      padding: 1.25rem;
      border-radius: 12px;
      margin-bottom: 1.25rem;
      box-shadow: 0 3px 10px rgba(0,0,0,0.08);
      transition: all 0.3s;
    }

    .dark-mode .box {
      background: var(--card-dark);
      box-shadow: 0 3px 10px rgba(0,0,0,0.3);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      background: var(--primary);
      color: white;
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin: 8px 8px 0 0;
      transition: all 0.2s;
      font-size: 0.95rem;
      text-decoration: none;
    }

    .btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .btn-secondary {
      background: var(--secondary);
    }

    .btn-danger {
      background: var(--danger);
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--primary);
      color: var(--primary);
    }

    .dark-mode .btn-outline {
      color: var(--text-light);
      border-color: var(--text-light);
    }

    #reader {
      width: 100%;
      position: relative;
      min-height: 300px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f0f0f0;
      border-radius: 8px;
      overflow: hidden;
    }

    .dark-mode #reader {
      background: #2a2a2a;
    }

    #reader video {
      width: 100%;
    }

    .scanner-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
    }

    .scanner-box {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 250px;
      height: 250px;
      border: 3px solid var(--primary);
      border-radius: 8px;
      box-shadow: 0 0 0 10000px rgba(0, 0, 0, 0.5);
    }

    .scanner-line {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background: var(--primary);
      animation: scan 2s infinite linear;
      box-shadow: 0 0 10px var(--primary);
    }

    @keyframes scan {
      0% { top: 0; }
      100% { top: 100%; }
    }

    .camera-selector {
      width: 100%;
      padding: 8px;
      margin-top: 10px;
      border-radius: 6px;
      border: 1px solid #ddd;
      background: white;
    }

    .dark-mode .camera-selector {
      background: #333;
      color: white;
      border-color: #555;
    }

    footer {
  background: #4CAF50;
  color: white;
  text-align: center;
  padding: 1rem 1rem;
  font-size: 0.9rem;
  position: fixed;
  bottom: 0;
  width: 100%;
  z-index: 100;
  box-shadow: 0 -2px 6px rgba(0,0,0,0.15);
} 
footer a {
  color: white;
  text-decoration: underline;
}

footer a:hover {
  color: #e0f7e9;
}

.dark-mode footer {
  background: #2E7D32;
  color: #ccc;
}

    input[type="file"] {
      width: 100%;
      margin-top: 10px;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: white;
    }

    .dark-mode input[type="file"] {
      background: #333;
      color: white;
      border-color: #555;
    }

    .history-item {
      padding: 12px 0;
      border-bottom: 1px solid #eee;
    }

    .dark-mode .history-item {
      border-bottom-color: #333;
    }

    .history-item:last-child {
      border-bottom: none;
    }

    .history-time {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .dark-mode .history-time {
      color: var(--text-muted-dark);
    }

    .barcode-type {
      display: inline-block;
      padding: 2px 6px;
      background: var(--primary);
      color: white;
      border-radius: 4px;
      font-size: 0.7rem;
      margin-left: 6px;
    }

    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      z-index: 1001;
      opacity: 0;
      transition: opacity 0.3s;
      max-width: 90%;
      text-align: center;
    }

    .toast.show {
      opacity: 1;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @media (min-width: 768px) {
      .sidebar {
        transform: translateX(0);
        position: fixed;
        height: 100%;
      }

      .overlay {
        display: none !important;
      }

      header .menu-toggle {
        display: none;
      }

      main {
        margin-left: 280px;
        max-width: calc(100% - 280px);
      }
    }

    @media (max-width: 600px) {
      header h1 {
        font-size: 1.2rem;
      }

      .sidebar {
        width: 85%;
      }
    }
  .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            animation: fadeOut 2s ease-in-out 3s forwards;
        }
        
        .logo {
            width: 120px;
            height: 120px;
            background-color: white;
            border-radius: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 30px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        .logo img {
            width: 80px;
            height: 80px;
        }
        
        .app-name {
            color: white;
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .tagline {
            color: rgba(255,255,255,0.9);
            font-size: 1.2rem;
            max-width: 80%;
            text-align: center;
            line-height: 1.4;
        }
        
        .loading {
            margin-top: 40px;
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @keyframes fadeOut {
            to { opacity: 0; visibility: hidden; }
        }
  main {
  padding-bottom: 80px; /* atau lebih besar jika footer tingginya besar */
}

  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
</head>
<body>
   
<!-- Splash Screen -->
<div id="splash" style="position:fixed; top:0; left:0; width:100%; height:100%; background:white; display:flex; align-items:center; justify-content:center; z-index:9999;">
  <img src="splashscreen.png" alt="ScanAja" style="width:200px;">
</div>
       
  <!-- SIDEBAR -->
  <div class="sidebar" id="sidebar">
    <h2>ScanAja</h2>
    <a href="#scanner-section" onclick="toggleSidebar()">
      <i class="fas fa-camera"></i> Pemindai Kamera
    </a>
    <a href="#image-section" onclick="toggleSidebar()">
      <i class="fas fa-image"></i> Scan dari Gambar
    </a>
    <a href="#generator-section" onclick="toggleSidebar()">
      <i class="fas fa-qrcode"></i> Buat QR Code
    </a>
    <a href="#history-section" onclick="toggleSidebar()">
      <i class="fas fa-history"></i> Riwayat Scan
    </a>
    <a href="javascript:void(0)" onclick="toggleDarkMode()">
      <i class="fas fa-moon"></i> Mode Gelap
    </a>
    <a href="#settings-section" onclick="toggleSidebar()">
      <i class="fas fa-cog"></i> Pengaturan
    </a>
    <a href="privacy.html" target="_blank">
      <i class="fas fa-shield-alt"></i> Kebijakan Privasi
    </a>
    <div style="margin-top: 2rem; padding: 0 10px;">
      <button class="btn" style="width: 100%;" onclick="installPWA()">
        <i class="fas fa-download"></i> Install Aplikasi
      </button>
    </div>
  </div>
  <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

  <!-- HEADER -->
  <header><div class="splash-logo">
  <img src="logo.png" alt="Logo ScanAja" width="48" height="48">
</div>
      <h1>ScanAja</h1>
    <button class="menu-toggle" onclick="toggleSidebar()">
      <i class="fas fa-bars"></i>
    </button>
  </header>

  <!-- MAIN CONTENT -->
  <main>
    <!-- Scanner Section -->
    <div id="scanner-section" class="box">
      <h2><i class="fas fa-camera"></i> Pemindai Kamera</h2>
      <div id="reader">
        <div class="scanner-overlay">
          <div class="scanner-box">
            <div class="scanner-line"></div>
          </div>
        </div>
        <p id="camera-loading" style="text-align: center;">
          <i class="fas fa-spinner fa-spin"></i> Memuat kamera...
        </p>
      </div>
      <select id="camera-select" class="camera-selector" style="display: none;">
        <option value="">Pilih Kamera</option>
      </select>
      <div style="display: flex; gap: 10px; margin-top: 10px;">
        <button id="start-camera" class="btn">
          <i class="fas fa-play"></i> Mulai
        </button>
        <button id="stop-camera" class="btn btn-danger" disabled>
          <i class="fas fa-stop"></i> Berhenti
        </button>
        <button id="flash-toggle" class="btn btn-secondary" disabled>
          <i class="fas fa-lightbulb"></i> Flash
        </button>
      </div>
    </div>

    <!-- Scan Result Section -->
    <div id="result-section" class="box" style="display: none;">
      <h2><i class="fas fa-check-circle"></i> Hasil Scan</h2>
      <div id="scan-result-content"></div>
      <div id="result-actions" style="margin-top: 15px;"></div>
    </div>

    <!-- Image Scan Section -->
    <div id="image-section" class="box">
      <h2><i class="fas fa-image"></i> Scan dari Gambar</h2>
      <p>Unggah gambar yang berisi QR code atau barcode:</p>
      <input type="file" id="image-upload" accept="image/*" capture="environment">
      <div id="image-preview" style="margin-top: 15px; text-align: center;"></div>
    </div>

    <!-- QR Generator Section -->
    <div id="generator-section" class="box">
      <h2><i class="fas fa-qrcode"></i> Buat QR Code</h2>
      <textarea id="qr-text" placeholder="Masukkan teks atau URL..." rows="3" 
        style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 10px;"></textarea>
      <button id="generate-qr" class="btn">
        <i class="fas fa-magic"></i> Buat QR Code
      </button>
      <div id="qr-result" style="margin-top: 20px; text-align: center;"></div>
      <div id="qr-download" style="margin-top: 15px; display: none;">
        <button id="download-qr" class="btn btn-secondary">
          <i class="fas fa-download"></i> Unduh QR Code
        </button>
      </div>
    </div>

    <!-- History Section -->
    <div id="history-section" class="box">
      <h2><i class="fas fa-history"></i> Riwayat Scan</h2>
      <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
        <button id="export-history" class="btn btn-secondary">
          <i class="fas fa-file-export"></i> Ekspor
        </button>
        <button onclick="clearHistory()" class="btn btn-danger">
          <i class="fas fa-trash"></i> Hapus Semua
        </button>
      </div>
      <div id="history-container">
        <ul id="history-list" style="list-style: none;"></ul>
      </div>
    </div>

    <!-- Settings Section -->
    <div id="settings-section" class="box">
      <h2><i class="fas fa-cog"></i> Pengaturan</h2>
      <div class="setting-item">
        <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
          <input type="checkbox" id="dark-mode-toggle" onchange="toggleDarkMode()">
          <span>Mode Gelap</span>
        </label>
      </div>
      <div class="setting-item">
        <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
          <input type="checkbox" id="sound-toggle" checked>
          <span>Suara saat berhasil scan</span>
        </label>
      </div>
      <div class="setting-item">
        <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
          <input type="checkbox" id="vibrate-toggle" checked>
          <span>Getar saat berhasil scan</span>
        </label>
      </div>
      <div class="setting-item">
        <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
          <input type="checkbox" id="auto-open-toggle" checked>
          <span>Buka URL otomatis</span>
        </label>
      </div>
    </div>
  </main>

  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>

  <!-- FOOTER -->
<footer>
  <p>&copy; 2025 ScanAja Powered by Fasim Dev</p>
  <p style="margin-top: 5px; font-size: 0.8rem;">
    <a href="privacy.html">Kebijakan Privasi</a> |
    <a href="terms.html">Syarat & Ketentuan</a>
  </p>
</footer>

  <!-- SCRIPTS -->
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <script>
    // DOM Elements
    const sidebar = document.getElementById("sidebar");
    const overlay = document.getElementById("overlay");
    const resultSection = document.getElementById("result-section");
    const scanResultContent = document.getElementById("scan-result-content");
    const resultActions = document.getElementById("result-actions");
    const historyList = document.getElementById("history-list");
    const cameraSelect = document.getElementById("camera-select");
    const startCameraBtn = document.getElementById("start-camera");
    const stopCameraBtn = document.getElementById("stop-camera");
    const flashToggleBtn = document.getElementById("flash-toggle");
    const imageUpload = document.getElementById("image-upload");
    const qrText = document.getElementById("qr-text");
    const generateQrBtn = document.getElementById("generate-qr");
    const qrResult = document.getElementById("qr-result");
    const qrDownload = document.getElementById("qr-download");
    const downloadQrBtn = document.getElementById("download-qr");
    const exportHistoryBtn = document.getElementById("export-history");
    const toast = document.getElementById("toast");
    const darkModeToggle = document.getElementById("dark-mode-toggle");
    const soundToggle = document.getElementById("sound-toggle");
    const vibrateToggle = document.getElementById("vibrate-toggle");
    const autoOpenToggle = document.getElementById("auto-open-toggle");

    // Global variables
    let html5QrCode;
    let currentCameraId;
    let deferredPrompt;
    let beepSound = new Audio('data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU...');

    // Initialize the app
    document.addEventListener('DOMContentLoaded', function() {
      // Load settings from localStorage
      loadSettings();
      
      // Initialize camera
      initCameraSelection();
      
      // Load history
      loadHistory();
      
      // Set up event listeners
      setupEventListeners();
      
      // Check for PWA install prompt
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
      });
    });

    // Sidebar toggle
    function toggleSidebar() {
      sidebar.classList.toggle("open");
      overlay.classList.toggle("show");
    }

    // Dark mode toggle
    function toggleDarkMode() {
      document.body.classList.toggle("dark-mode");
      const isDarkMode = document.body.classList.contains("dark-mode");
      localStorage.setItem('darkMode', isDarkMode);
      darkModeToggle.checked = isDarkMode;
    }

    // Load settings from localStorage
    function loadSettings() {
      const darkMode = localStorage.getItem('darkMode') === 'true';
      if (darkMode) {
        document.body.classList.add("dark-mode");
        darkModeToggle.checked = true;
      }
      
      const soundEnabled = localStorage.getItem('soundEnabled') !== 'false';
      soundToggle.checked = soundEnabled;
      
      const vibrateEnabled = localStorage.getItem('vibrateEnabled') !== 'false';
      vibrateToggle.checked = vibrateEnabled;
      
      const autoOpenEnabled = localStorage.getItem('autoOpenEnabled') !== 'false';
      autoOpenToggle.checked = autoOpenEnabled;
    }

    // Initialize camera selection
    async function initCameraSelection() {
      try {
        const cameras = await Html5Qrcode.getCameras();
        if (cameras && cameras.length > 0) {
          cameraSelect.innerHTML = '<option value="">Pilih Kamera</option>';
          cameras.forEach(camera => {
            const option = document.createElement('option');
            option.value = camera.id;
            option.text = camera.label || `Kamera ${cameraSelect.length}`;
            cameraSelect.appendChild(option);
          });
          cameraSelect.style.display = 'block';
          currentCameraId = cameras[0].id;
          cameraSelect.value = currentCameraId;
        } else {
          showToast('Tidak ada kamera yang ditemukan');
        }
      } catch (error) {
        console.error('Error getting cameras:', error);
        showToast('Gagal mengakses kamera');
      }
    }

    // Start camera scanning
    async function startCamera() {
      const cameraId = cameraSelect.value;
      if (!cameraId) {
        showToast('Silakan pilih kamera terlebih dahulu');
        return;
      }

      try {
        document.getElementById('camera-loading').style.display = 'block';
        startCameraBtn.disabled = true;
        
        html5QrCode = new Html5Qrcode("reader");
        await html5QrCode.start(
          cameraId,
          {
            fps: 10,
            qrbox: { width: 250, height: 250 },
            aspectRatio: 1.0
          },
          (decodedText, decodedResult) => {
            handleScanSuccess(decodedText, decodedResult);
          },
          (errorMessage) => {
            // Handle scan error
          }
        ).then(() => {
          document.getElementById('camera-loading').style.display = 'none';
          startCameraBtn.disabled = true;
          stopCameraBtn.disabled = false;
          flashToggleBtn.disabled = false;
          currentCameraId = cameraId;
          showToast('Pemindaian dimulai');
        }).catch(err => {
          console.error('Failed to start camera:', err);
          document.getElementById('camera-loading').style.display = 'none';
          startCameraBtn.disabled = false;
          showToast('Gagal memulai kamera: ' + err.message);
        });
      } catch (error) {
        console.error('Error starting camera:', error);
        document.getElementById('camera-loading').style.display = 'none';
        startCameraBtn.disabled = false;
        showToast('Error: ' + error.message);
      }
    }

    // Stop camera scanning
    async function stopCamera() {
      try {
        if (html5QrCode && html5QrCode.isScanning) {
          await html5QrCode.stop();
          startCameraBtn.disabled = false;
          stopCameraBtn.disabled = true;
          flashToggleBtn.disabled = true;
          showToast('Pemindaian dihentikan');
        }
      } catch (error) {
        console.error('Error stopping camera:', error);
        showToast('Gagal menghentikan kamera');
      }
    }

    // Toggle flash/torch
    async function toggleFlash() {
      try {
        if (html5QrCode) {
          const isFlashOn = await html5QrCode.getRunningTrackCapabilities()
            .then(capabilities => capabilities.torch);
          
          if (isFlashOn) {
            await html5QrCode.applyVideoConstraints({ advanced: [{torch: false}] });
            flashToggleBtn.innerHTML = '<i class="fas fa-lightbulb"></i> Flash';
          } else {
            await html5QrCode.applyVideoConstraints({ advanced: [{torch: true}] });
            flashToggleBtn.innerHTML = '<i class="fas fa-lightbulb"></i> Matikan';
          }
        }
      } catch (error) {
        console.error('Error toggling flash:', error);
        showToast('Perangkat tidak mendukung flash');
      }
    }

    // Handle successful scan
    function handleScanSuccess(decodedText, decodedResult) {
      // Play sound if enabled
      if (soundToggle.checked) {
        beepSound.play().catch(e => console.log('Cannot play sound:', e));
      }
      
      // Vibrate if enabled and supported
      if (vibrateToggle.checked && navigator.vibrate) {
        navigator.vibrate(200);
      }
      
      // Stop camera if continuous scan is not preferred
      stopCamera();
      
      // Display result
      showScanResult(decodedText, decodedResult);
      
      // Save to history
      saveHistory(decodedText, decodedResult.format);
      
      // Auto-open URL if enabled and valid
      if (autoOpenToggle.checked && isValidUrl(decodedText)) {
        setTimeout(() => {
          window.open(decodedText, '_blank');
        }, 500);
      }
    }

    // Show scan result
    function showScanResult(text, format) {
      resultSection.style.display = 'block';
      scanResultContent.innerHTML = `
        <p><strong>Format:</strong> <span class="barcode-type">${format || 'QR Code'}</span></p>
        <div style="margin: 15px 0; padding: 15px; background: #f5f5f5; border-radius: 8px; word-break: break-all;">
          ${text}
        </div>
      `;
      
      // Create action buttons
      resultActions.innerHTML = '';
      
      if (isValidUrl(text)) {
        const openBtn = document.createElement('button');
        openBtn.className = 'btn';
        openBtn.innerHTML = '<i class="fas fa-external-link-alt"></i> Buka Link';
        openBtn.onclick = () => window.open(text, '_blank');
        resultActions.appendChild(openBtn);
      }
      
      const shareBtn = document.createElement('button');
      shareBtn.className = 'btn btn-secondary';
      shareBtn.innerHTML = '<i class="fas fa-share"></i> Bagikan';
      shareBtn.onclick = () => shareResult(text);
      resultActions.appendChild(shareBtn);
      
      const copyBtn = document.createElement('button');
      copyBtn.className = 'btn';
      copyBtn.innerHTML = '<i class="fas fa-copy"></i> Salin';
      copyBtn.onclick = () => copyToClipboard(text);
      resultActions.appendChild(copyBtn);
      
      // Scroll to result
      resultSection.scrollIntoView({ behavior: 'smooth' });
    }

    // Scan from image
    imageUpload.addEventListener('change', async function(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      try {
        showToast('Memproses gambar...');
        
        // Show image preview
        const reader = new FileReader();
        reader.onload = function(event) {
          document.getElementById('image-preview').innerHTML = `
            <img src="${event.target.result}" style="max-width: 100%; max-height: 300px; border-radius: 8px;">
          `;
        };
        reader.readAsDataURL(file);
        
        // Scan the image
        const result = await Html5Qrcode.scanFile(file, true);
        handleScanSuccess(result.text, result.format);
        showToast('Berhasil memindai gambar');
      } catch (error) {
        console.error('Error scanning image:', error);
        showToast('Gagal memindai gambar');
      }
    });

    // Generate QR code
    generateQrBtn.addEventListener('click', function() {
      const text = qrText.value.trim();
      if (!text) {
        showToast('Masukkan teks atau URL terlebih dahulu');
        return;
      }
      
      try {
        QRCode.toCanvas(text, { width: 200, margin: 2 }, (error, canvas) => {
          if (error) {
            console.error('Error generating QR code:', error);
            showToast('Gagal membuat QR code');
            return;
          }
          
          qrResult.innerHTML = '';
          qrResult.appendChild(canvas);
          qrDownload.style.display = 'block';
          
          // Set up download button
          downloadQrBtn.onclick = function() {
            const link = document.createElement('a');
            link.download = 'qrcode.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
          };
          
          showToast('QR code berhasil dibuat');
        });
      } catch (error) {
        console.error('Error generating QR code:', error);
        showToast('Gagal membuat QR code');
      }
    });

    // Save scan history
    function saveHistory(text, format) {
      const history = JSON.parse(localStorage.getItem('scanHistory') || '[]');
      history.unshift({
        text,
        format: format || 'QR Code',
        timestamp: new Date().toISOString()
      });
      
      // Keep only the last 100 items
      if (history.length > 100) {
        history.pop();
      }
      
      localStorage.setItem('scanHistory', JSON.stringify(history));
      loadHistory();
    }

    // Load scan history
    function loadHistory() {
      const history = JSON.parse(localStorage.getItem('scanHistory') || '[]');
      historyList.innerHTML = history.map(item => `
        <li class="history-item">
          <div style="word-break: break-all;">${item.text}</div>
          <div class="history-time">
            <span class="barcode-type">${item.format}</span>
            ${new Date(item.timestamp).toLocaleString()}
          </div>
        </li>
      `).join('');
    }

    // Clear history
    function clearHistory() {
      if (confirm('Apakah Anda yakin ingin menghapus semua riwayat scan?')) {
        localStorage.removeItem('scanHistory');
        loadHistory();
        showToast('Riwayat scan dihapus');
      }
    }

    // Export history
    exportHistoryBtn.addEventListener('click', function() {
      const history = JSON.parse(localStorage.getItem('scanHistory') || '[]');
      if (history.length === 0) {
        showToast('Tidak ada riwayat untuk diekspor');
        return;
      }
      
      const csvContent = "data:text/csv;charset=utf-8," +
        history.map(item => `"${item.text.replace(/"/g, '""')}",${item.format},"${item.timestamp}"`).join("\n");
      
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "scan_history.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showToast('Riwayat berhasil diekspor');
    });

    // Share result
    function shareResult(text) {
      if (navigator.share) {
        navigator.share({
          title: 'Hasil Scan QR Code',
          text: text,
          url: isValidUrl(text) ? text : undefined
        }).catch(err => {
          console.log('Error sharing:', err);
          showToast('Berbagi dibatalkan');
        });
      } else {
        copyToClipboard(text);
        showToast('Teks disalin ke clipboard');
      }
    }

    // Copy to clipboard
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        showToast('Teks disalin ke clipboard');
      }).catch(err => {
        console.error('Failed to copy:', err);
        showToast('Gagal menyalin teks');
      });
    }

    // Show toast notification
    function showToast(message) {
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // Check if string is a valid URL
    function isValidUrl(string) {
      try {
        new URL(string);
        return true;
      } catch (_) {
        return false;
      }
    }

    // PWA installation
    function installPWA() {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
          if (choiceResult.outcome === 'accepted') {
            console.log('User accepted the install prompt');
          } else {
            console.log('User dismissed the install prompt');
          }
          deferredPrompt = null;
        });
      } else {
        showToast('Gunakan menu browser untuk menginstall aplikasi');
      }
    }

    // Set up event listeners
    function setupEventListeners() {
      // Camera controls
      startCameraBtn.addEventListener('click', startCamera);
      stopCameraBtn.addEventListener('click', stopCamera);
      flashToggleBtn.addEventListener('click', toggleFlash);
      cameraSelect.addEventListener('change', function() {
        if (html5QrCode && html5QrCode.isScanning) {
          stopCamera().then(startCamera);
        }
      });
      
      // Settings toggles
      soundToggle.addEventListener('change', function() {
        localStorage.setItem('soundEnabled', this.checked);
      });
      
      vibrateToggle.addEventListener('change', function() {
        localStorage.setItem('vibrateEnabled', this.checked);
      });
      
      autoOpenToggle.addEventListener('change', function() {
        localStorage.setItem('autoOpenEnabled', this.checked);
      });
      
      darkModeToggle.addEventListener('change', toggleDarkMode);
    }
  
   window.addEventListener("load", function () {
    setTimeout(function () {
      const splash = document.getElementById("splash");
      if (splash) splash.style.display = "none";
    }, 2500); // 2.5 detik
  });
  
  window.addEventListener("load", function () {
    setTimeout(function () {
      const splash = document.getElementById("splashScreen");
      if (splash) splash.style.display = "none";
    }, 3000); // Hilang dalam 3 detik
  });
  </script>
  
</body>
</html>
